<!DOCTYPE html>
<html>
<head>
    <title>Search Test</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 40px; }
        .test-container { margin: 20px 0; padding: 20px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .search-input { width: 300px; padding: 10px; border: 1px solid #ccc; }
        #search { border: 1px solid #eee; margin-top: 10px; max-height: 400px; overflow-y: auto; }
        .search-results table { width: 100%; border-collapse: collapse; }
        .search-results tr { cursor: pointer; border-bottom: 1px solid #eee; }
        .search-results tr:hover { background: #f5f5f5; }
        .search-results td { padding: 8px; }
        .type { font-size: 0.8em; color: #666; margin-right: 5px; }
        .type.function { color: #2BAB63; }
        .type.struct { color: #2DBFB8; }
        .type.trait { color: #B78CF2; }
        .desc { font-size: 0.9em; color: #666; }
    </style>
</head>
<body>
    <h1>Search Functionality Test</h1>
    
    <div class="test-container">
        <h2>Test 1: Load Documentation Data</h2>
        <div id="load-test">Loading...</div>
    </div>
    
    <div class="test-container">
        <h2>Test 2: Interactive Search</h2>
        <form id="search-form" class="search-form">
            <div class="search-container">
                <input id="search-input" class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Type 'asset' to test search..." type="search">
            </div>
        </form>
        <div id="search-status">Type in the search box above...</div>
        <section id="search" class="search-results"></section>
    </div>
    
    <div class="test-container">
        <h2>Test Results</h2>
        <ul id="test-results"></ul>
    </div>

    <script>
        let testResults = [];
        
        function addTestResult(test, passed, message) {
            testResults.push({ test, passed, message });
            const resultsEl = document.getElementById('test-results');
            const li = document.createElement('li');
            li.className = passed ? 'success' : 'error';
            li.textContent = `${test}: ${passed ? '‚úÖ PASS' : '‚ùå FAIL'} - ${message}`;
            resultsEl.appendChild(li);
        }
        
        async function loadDocumentationData() {
            const loadTestEl = document.getElementById('load-test');
            try {
                const response = await fetch('http://localhost:3000/docs/pure?ipfs=QmexhLHpyb6TMArffS6prZesMnYu53FdL7ThEA5F3ab3va');
                const html = await response.text();
                
                // Extract SEARCH_INDEX
                const indexMatch = html.match(/var SEARCH_INDEX=(\{.*?\});/s);
                if (indexMatch) {
                    window.SEARCH_INDEX = JSON.parse(indexMatch[1]);
                    loadTestEl.innerHTML = '<span class="success">‚úÖ Documentation data loaded successfully</span>';
                    addTestResult('Load Data', true, `Loaded ${window.SEARCH_INDEX.std.length} search items`);
                    return true;
                } else {
                    throw new Error('Could not find SEARCH_INDEX in HTML');
                }
            } catch (error) {
                loadTestEl.innerHTML = `<span class="error">‚ùå Failed to load: ${error.message}</span>`;
                addTestResult('Load Data', false, error.message);
                return false;
            }
        }
        
        function initSearchTest() {
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search');
            const searchStatus = document.getElementById('search-status');
            
            if (!searchInput || !searchResults || typeof window.SEARCH_INDEX === 'undefined') {
                addTestResult('Init Search', false, 'Missing required elements or data');
                return false;
            }
            
            addTestResult('Init Search', true, 'Search elements found and initialized');
            
            function getSearchScore(item, query) {
                let score = 0;
                const name = item.name.toLowerCase();
                const preview = (item.preview || '').toLowerCase();
                
                if (name === query) score += 1000;
                else if (name.startsWith(query)) score += 100;
                else if (name.includes(query)) score += 50;
                
                if (preview.includes(query)) score += 10;
                
                if (item.module_info && item.module_info.join('::').toLowerCase().includes(query)) {
                    score += 20;
                }
                
                return score;
            }
            
            function performSearch(query) {
                if (!query.trim()) {
                    searchResults.innerHTML = '';
                    searchResults.style.display = 'none';
                    searchStatus.textContent = 'Type in the search box above...';
                    return;
                }
                
                const results = [];
                const queryLower = query.toLowerCase();
                
                for (const crate in window.SEARCH_INDEX) {
                    const items = window.SEARCH_INDEX[crate] || [];
                    for (const item of items) {
                        const score = getSearchScore(item, queryLower);
                        if (score > 0) {
                            results.push({ ...item, score, crate });
                        }
                    }
                }
                
                results.sort((a, b) => b.score - a.score);
                const topResults = results.slice(0, 50);
                
                searchStatus.textContent = `Found ${results.length} results for "${query}"`;
                displayResults(topResults, query);
                
                // Test that we got results
                if (query.toLowerCase() === 'asset' && results.length > 0) {
                    addTestResult('Search "asset"', true, `Found ${results.length} results`);
                }
            }
            
            function displayResults(results, query) {
                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="search-failed active"><p>No results found.</p></div>';
                    searchResults.style.display = 'block';
                    if (query.toLowerCase() === 'asset') {
                        addTestResult('Search "asset"', false, 'No results found');
                    }
                    return;
                }
                
                const resultsHtml = results.map(item => {
                    const modulePath = item.module_info ? item.module_info.join('::') : '';
                    const typeClass = item.type_name ? item.type_name.toLowerCase() : '';
                    const url = '/docs/pure?ipfs=QmexhLHpyb6TMArffS6prZesMnYu53FdL7ThEA5F3ab3va&file=std/' + item.html_filename;
                    
                    return '<div class="search-results"><table><tr onclick="window.location=\'' + url + '\'"><td><span class="type ' + typeClass + '">' + (item.type_name || '') + '</span><strong>' + item.name + '</strong><div class="desc">' + modulePath + '</div></td><td><div class="desc">' + (item.preview || '') + '</div></td></tr></table></div>';
                }).join('');
                
                searchResults.innerHTML = resultsHtml;
                searchResults.style.display = 'block';
            }
            
            // Handle search input
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch(e.target.value);
                }, 150);
            });
            
            // Auto-test search for "asset"
            setTimeout(() => {
                searchInput.value = 'asset';
                performSearch('asset');
            }, 1000);
            
            return true;
        }
        
        // Run tests
        async function runTests() {
            const dataLoaded = await loadDocumentationData();
            if (dataLoaded) {
                initSearchTest();
                
                setTimeout(() => {
                    const passedTests = testResults.filter(t => t.passed).length;
                    const totalTests = testResults.length;
                    
                    const summary = document.createElement('h3');
                    summary.textContent = `Test Summary: ${passedTests}/${totalTests} tests passed`;
                    summary.className = passedTests === totalTests ? 'success' : 'error';
                    document.getElementById('test-results').prepend(summary);
                    
                    if (passedTests === totalTests) {
                        console.log('üéâ ALL TESTS PASSED! Search functionality is working.');
                    } else {
                        console.log('‚ùå Some tests failed.');
                    }
                }, 2000);
            }
        }
        
        runTests();
    </script>
</body>
</html>