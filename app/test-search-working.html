<!DOCTYPE html>
<html>
<head>
    <title>Test Search Functionality</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .test-result { padding: 10px; margin: 10px 0; border: 2px solid; }
        .pass { border-color: green; background: #e8f5e8; }
        .fail { border-color: red; background: #f5e8e8; }
        iframe { width: 100%; height: 400px; border: 1px solid #ccc; margin: 10px 0; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; font-size: 12px; }
    </style>
</head>
<body>
    <h1>🧪 Search Functionality Test</h1>
    
    <div id="test-status">🔄 Loading test...</div>
    
    <iframe id="docs-frame" src="http://localhost:3000/docs/std/index.html"></iframe>
    
    <div id="test-log" class="log"></div>
    
    <script>
        const testLog = document.getElementById('test-log');
        const testStatus = document.getElementById('test-status');
        
        function log(message) {
            console.log(message);
            testLog.innerHTML += message + '\\n';
        }
        
        function setStatus(message, isPass) {
            testStatus.innerHTML = message;
            testStatus.className = 'test-result ' + (isPass ? 'pass' : 'fail');
        }
        
        document.getElementById('docs-frame').onload = function() {
            setTimeout(() => {
                try {
                    const frame = document.getElementById('docs-frame');
                    const frameDoc = frame.contentDocument || frame.contentWindow.document;
                    
                    log('✅ Page loaded successfully');
                    
                    // Check if search input exists
                    const searchInput = frameDoc.getElementById('search-input');
                    if (!searchInput) {
                        setStatus('❌ FAIL: Search input not found', false);
                        return;
                    }
                    log('✅ Search input found');
                    
                    // Check if search results container exists
                    const searchSection = frameDoc.getElementById('search');
                    if (!searchSection) {
                        setStatus('❌ FAIL: Search results container not found', false);
                        return;
                    }
                    log('✅ Search results container found');
                    
                    // Check if SEARCH_INDEX is available
                    const hasSearchIndex = frame.contentWindow.SEARCH_INDEX ? true : false;
                    if (!hasSearchIndex) {
                        setStatus('❌ FAIL: SEARCH_INDEX not available', false);
                        return;
                    }
                    log('✅ SEARCH_INDEX available');
                    
                    // Type 'a' in search input
                    log('🔍 Typing "a" in search input...');
                    searchInput.value = 'a';
                    
                    // Trigger input event
                    const inputEvent = new Event('input', { bubbles: true });
                    searchInput.dispatchEvent(inputEvent);
                    
                    // Wait for search to complete
                    setTimeout(() => {
                        const searchHTML = searchSection.innerHTML;
                        log('📄 Search section HTML: ' + searchHTML.substring(0, 200) + '...');
                        
                        // Test 1: Should contain "Results for a"
                        const hasResultsHeader = searchHTML.includes('Results for "a"') || searchHTML.includes('Results for a');
                        
                        // Test 2: Should show search results (not empty or hidden)
                        const hasResults = searchHTML.trim().length > 0 && 
                                          !searchHTML.includes('No results found') &&
                                          searchSection.style.display !== 'none';
                        
                        // Test 3: Should contain some expected items that start with 'a'
                        const hasExpectedResults = searchHTML.includes('address') || 
                                                  searchHTML.includes('asset') || 
                                                  searchHTML.includes('assert');
                        
                        log('📊 Test Results:');
                        log('  - Has "Results for a" header: ' + hasResultsHeader);
                        log('  - Has non-empty results: ' + hasResults);
                        log('  - Contains expected items: ' + hasExpectedResults);
                        log('  - Search section display: ' + searchSection.style.display);
                        log('  - Search section class: ' + searchSection.className);
                        
                        if (hasResultsHeader && hasResults && hasExpectedResults) {
                            setStatus('🎉 PASS: Search functionality works correctly!', true);
                            log('✅ SUCCESS: When typing "a", the page shows "Results for a" with a list of matching types');
                        } else {
                            setStatus('❌ FAIL: Search functionality is broken', false);
                            log('❌ FAILURE: Search does not work as expected');
                            
                            // Additional debugging
                            log('🔧 Debug Info:');
                            log('  - Search input value: "' + searchInput.value + '"');
                            log('  - Main content display: ' + (frameDoc.getElementById('main-content')?.style.display || 'default'));
                            log('  - Full search HTML: ' + searchHTML);
                        }
                        
                    }, 1000); // Wait 1 second for search to complete
                    
                } catch (error) {
                    setStatus('❌ FAIL: Test error - ' + error.message, false);
                    log('💥 Test error: ' + error.message);
                    log('🔧 This might be due to CORS restrictions or the page not loading properly');
                }
            }, 2000); // Wait 2 seconds for page to fully load
        };
        
        // Timeout fallback
        setTimeout(() => {
            if (testStatus.innerHTML.includes('Loading test')) {
                setStatus('❌ FAIL: Test timed out', false);
                log('⏰ Test timed out - page may not have loaded');
            }
        }, 10000);
    </script>
</body>
</html>